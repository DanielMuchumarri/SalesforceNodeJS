const mysql2json = require('./index');
const mysql = require("mysql2");

async function main(){
    const db = mysql2json({
        host: 'db4free.net',
        user: 'khairtex',
        password: 'qw5DtfnR*Vdc@tc',
        database: 'khairtex',
        waitForConnections: true,
        connectionLimit: 5,
        queueLimit: 0
    });

    const tables = await db.khairtex.tables();

    var query = {
        _id: {$gte:20},
        'orders.no_wait':'N',

    }

    // db.find(query).projection({_id:1})
    //     .join('orders',{},{
    //         'packing._id':'orders.packing_id',
    //         'orders.customer_to':12,
    //         'orders.shipment_id':23
    //     }).groupBy(['_id'])
    //     .exec((e,d)=>{
    //         console.log(d);
    //         //process.exit()
    //     });
    // console.log('test');

    tables.packing.find({})
        .leftjoin('courier_type',{type:1},{'courier_type._id':'courier_type_id'})
        .leftjoin('courier',{name:1},{'courier._id':'courier_type.courier_id'})
        .join(tables.orders.find()
            .projection({
                packing_id:1,
                $max:{
                    status:1
                }
            })
            .groupBy(['packing_id'])
            .having({$max:{status:'PAID'}})
            .build(),{},{'orders.packing_id':'packing._id'})
        .exec((err, m) => {
            console.log(m);
        });
}

main()